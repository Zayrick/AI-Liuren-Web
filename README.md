# äº‘å å°å…­å£¬ â€“ Cloudflare Workers / PWA

> åŸºäº **Cloudflare Workers** âœ• **AI å¤§æ¨¡å‹** çš„åœ¨çº¿å åœåº”ç”¨ï¼Œå¹¶æä¾›ç¦»çº¿è®¿é—®ï¼ˆPWAï¼‰ã€‚

---

## âœ¨ åŠŸèƒ½äº®ç‚¹

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| AI æµå¼è§£å¦ | åç«¯ä»¥ **SSE** æ¨é€æ¨ç†è¿‡ç¨‹åŠç­”æ¡ˆï¼Œå‰ç«¯å®æ—¶æ¸²æŸ“ï¼Œæ¯«ç§’çº§å»¶è¿Ÿã€‚ |
| é›¶è¿ç»´éƒ¨ç½² | éƒ¨ç½²è‡³ Cloudflare Workersï¼Œå…¨çƒç™¾æ¯«ç§’è®¿é—®ï¼Œæ— éœ€æœåŠ¡å™¨è¿ç»´ã€‚ |
| PWA ç¦»çº¿æ”¯æŒ | é€šè¿‡ `service-worker.js` + `manifest.json`ï¼Œå¯ä¸€é”®å®‰è£…åˆ°æ¡Œé¢ / æ‰‹æœºã€‚ |
| æ¨¡å—åŒ–ç®—æ³• | å¹²æ”¯ã€å¦è±¡ã€æ—¶è¾°è®¡ç®—å‡æ‹†åˆ†è‡³ `lib/`ï¼Œé€»è¾‘æ¸…æ™°ã€æ˜“ç»´æŠ¤ã€‚ |

---

## ğŸ—‚ï¸ ç›®å½•ç»“æ„

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `worker.js` | Cloudflare Worker å…¥å£ï¼Œå®ç° API è·¯ç”± + é™æ€èµ„æºæœåŠ¡ã€‚ |
| `static/` | å‰ç«¯é™æ€èµ„æºç›®å½•ï¼ˆHTML / CSS / JS / å›¾æ ‡ â€¦ï¼‰ã€‚ |
| `lib/` | å åœæ ¸å¿ƒç®—æ³•æ¨¡å—ã€‚ |
| `wrangler.toml` | Wrangler é…ç½®æ–‡ä»¶ã€‚ |
| `.wranglerignore` | éƒ¨ç½²å¿½ç•¥è§„åˆ™ï¼Œé¿å…ä¸Šä¼ æ— å…³æ–‡ä»¶ã€‚ |
| `.dev.vars` / `.dev.vars.example` | æœ¬åœ°ç¯å¢ƒå˜é‡æ–‡ä»¶ (**å‹¿æäº¤ Git**ï¼Œå·²åœ¨ `.gitignore` ä¸­)ã€‚ |

---

## âš™ï¸ å…ˆå†³æ¡ä»¶

1. **Node.js â‰¥ 18**ï¼ˆä»…ç”¨äºå®‰è£…/è¿è¡Œ Wranglerï¼‰ã€‚
2. **npm / pnpm / yarn**ï¼ˆä»»é€‰å…¶ä¸€ï¼‰ã€‚
3. **Cloudflare è´¦å·**ï¼Œå·²å¼€é€š Workersã€‚  
4. **AI å¤§æ¨¡å‹ API Key**ï¼ˆOpenAI / OpenRouter ç­‰ï¼‰ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£… Wrangler CLI

```powershell
npm i -g wrangler   # æˆ– pnpm add -g wrangler
```

### 2. å…‹éš†ä»“åº“

```powershell
git clone https://github.com/<your>/<repo>.git
cd <repo>
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```powershell
cp .dev.vars.example .dev.vars   # Windows ç”¨æˆ·ä½¿ç”¨ copy
```

ç¼–è¾‘ `.dev.vars`ï¼š

```env
API_KEY=sk-xxxxxxxxxxxxxxxx
ENDPOINT=https://api.openai.com/v1/chat/completions
MODEL=gpt-4o
SYSTEM_PROMPT=ä½ æ˜¯ä¸€ä½ç²¾é€šå°å…­å£¬çš„å›½å­¦å¤§å¸ˆâ€¦â€¦
```

> çº¿ä¸Šéƒ¨ç½²æ—¶ï¼Œåœ¨ Cloudflare æ§åˆ¶å° **Workers â†’ Settings â†’ Variables** ä¸­æ·»åŠ åŒåå˜é‡å³å¯ã€‚

### 4. æœ¬åœ°å¼€å‘

```powershell
# ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿå™¨è¿è¡Œï¼ˆç«¯å£ 8787ï¼‰
npm run dev         # å®é™…æ‰§è¡Œï¼šwrangler dev --local
```

æ‰“å¼€æµè§ˆå™¨è®¿é—® <http://localhost:8787> å³å¯ä½“éªŒå®Œæ•´åŠŸèƒ½ï¼ˆå« PWA å®‰è£…æç¤ºï¼‰ã€‚

---

## ğŸŒ API è¯´æ˜

### ç«¯ç‚¹

```
POST /api/divination
Accept: text/event-stream
Content-Type: application/json
```

### è¯·æ±‚ä½“

```json5
{
  "numbers": [3, 5, 2],          // ä¸‰ä¸ªæ­£æ•´æ•°
  "question": "ä»Šå¹´äº‹ä¸šå¦‚ä½•ï¼Ÿ",   // å¾…å åœé—®é¢˜
  "show_reasoning": true,       // æ˜¯å¦æ¨é€æ¨ç†è¿‡ç¨‹ï¼ˆé»˜è®¤ trueï¼‰
  "apiKey": "...",            // å¯è¦†ç›–å…¨å±€ API_KEY
  "model": "openai/gpt-4o",   // å¯è¦†ç›–å…¨å±€ MODEL
  "endpoint": "https://...",  // å¯è¦†ç›–å…¨å±€ ENDPOINT
  "clientTime": {               // å¯é€‰ï¼Œå®¢æˆ·ç«¯æœ¬åœ°æ—¶é—´
    "ts": 1718511692000,
    "tz_offset": -480
  }
}
```

### SSE äº‹ä»¶æµ

| event | data ç¤ºä¾‹ | è¯´æ˜ |
|-------|-----------|------|
| `meta` | `{ "hexagram": "å¤§å®‰ å°å‰ ç©ºäº¡", "time": "ç”²è¾°å¹´ ä¸™å¯…æœˆ æˆŠç”³æ—¥ ç”²å­æ—¶" }` | èµ·å¦ç»“æœ + å…«å­—æ—¶é—´ |
| `reasoning` | `æ­£åœ¨åˆ†æç¬¬ä¸€å¦â€¦` | ï¼ˆå¯é€‰ï¼‰AI æ¨ç†è¿‡ç¨‹ |
| `answer` | `äº‹ä¸šæ•´ä½“è¶‹ç¨³â€¦` | æœ€ç»ˆè§£å¦å†…å®¹ï¼ˆè¿ç»­å¤šå¸§ï¼‰ |
| `error` | `é”™è¯¯ä¿¡æ¯` | å¼‚å¸¸æç¤º |

---

## ğŸ› ï¸ å¸¸ç”¨è„šæœ¬

| å‘½ä»¤ | ä½œç”¨ |
|------|------|
| `npm run dev` | æœ¬åœ°å¼€å‘ (Workers æ¨¡æ‹Ÿå™¨) |
| `npm run dev:remote` | è¿œç¨‹å¼€å‘ï¼Œç›´æ¥åœ¨ Cloudflare è¾¹ç¼˜è¿è¡Œ |
| `npm run deploy` | å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ |

---

## â˜ï¸ éƒ¨ç½²åˆ° Cloudflare Workers

```powershell
npm run deploy     # ç­‰ä»·äºï¼šwrangler deploy
```

éƒ¨ç½²å®Œæˆåï¼ŒWrangler ä¼šè¾“å‡º Workers URLï¼Œä¾‹å¦‚ `https://yunzhan-xiaoliuren.<subdomain>.workers.dev`ï¼Œä¹Ÿå¯ç»‘å®šè‡ªå®šä¹‰åŸŸåã€‚

---

## â“ å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| `401 Unauthorized` | æ£€æŸ¥ `API_KEY` æ˜¯å¦æ­£ç¡®ã€æœªè¿‡æœŸä¸”å·²ç»‘å®šç¯å¢ƒå˜é‡ã€‚ |
| `Failed to fetch` | æŸ¥çœ‹ Wrangler æ—¥å¿— (`wrangler tail`)ï¼Œç¡®è®¤åç«¯æœªæŠ›å¼‚å¸¸ï¼Œç½‘ç»œå¯è¾¾ã€‚ |
| SSE æ— æ•°æ® / æ–­æµ | ç¡®è®¤æµè§ˆå™¨æœªè¢«ä»£ç†/æ’ä»¶æ‹¦æˆªï¼›åˆ‡åå°ä¼šè¢«æµè§ˆå™¨èŠ‚æµï¼Œå»ºè®®ä¿æŒå½“å‰æ ‡ç­¾é¡µæ¿€æ´»ã€‚ |
| PWA ç¦»çº¿å¤±æ•ˆ | æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ & Service Workerï¼Œç„¶åé‡æ–°è®¿é—®ç”Ÿäº§åŸŸåã€‚ |

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®æºç ä»¥ **MIT License** å¼€æºï¼Œå•†ä¸šä½¿ç”¨è¯·éµå®ˆæ¡æ¬¾ã€‚

---

> ğŸ‰ æ¬¢è¿ Issue / PRï¼Œä¸æˆ‘ä»¬ä¸€åŒå®Œå–„ â€œäº‘å å°å…­å£¬â€ï¼ 